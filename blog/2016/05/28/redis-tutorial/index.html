<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.17" />



<link rel="canonical" href="http://kingjcy.github.io/blog/2016/05/28/redis-tutorial/">


    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <title>redis tutorial - kingjcy Blog</title>
    
<meta name="description" content="&lt;p&gt;redis是一款高性能的key-value型数据库，目前受到了强烈的欢迎和广泛的使用。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;">

<meta property="og:title" content="redis tutorial - kingjcy Blog">
<meta property="og:type" content="article">
<meta property="og:url" content="http://kingjcy.github.io/blog/2016/05/28/redis-tutorial/">
<meta property="og:image" content="http://kingjcy.github.io/images/default.png">
<meta property="og:site_name" content="kingjcy Blog">
<meta property="og:description" content="&lt;p&gt;redis是一款高性能的key-value型数据库，目前受到了强烈的欢迎和广泛的使用。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="kingjcy Blog">
<meta name="twitter:url" content="http://kingjcy.github.io/blog/2016/05/28/redis-tutorial/">
<meta name="twitter:title" content="redis tutorial - kingjcy Blog">
<meta name="twitter:description" content="&lt;p&gt;redis是一款高性能的key-value型数据库，目前受到了强烈的欢迎和广泛的使用。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;">
<meta name="twitter:image" content="http://kingjcy.github.io/images/default.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"http:\/\/kingjcy.github.io\/"
    },
    "headline": "redis tutorial - kingjcy Blog",
    "image": {
      "@type": "ImageObject",
      "url": "http:\/\/kingjcy.github.io\/images\/default.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2016-05-28T09:56:46JST",
    "dateModified": "2016-05-28T09:56:46JST",
    "author": {
      "@type": "Person",
      "name": "kingjcy Blog"
    },
    "publisher": {
      "@type": "Organization",
      "name": "kingjcy Blog",
      "logo": {
        "@type": "ImageObject",
        "url": "http:\/\/kingjcy.github.io\/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "\x3cp\x3eredis是一款高性能的key-value型数据库，目前受到了强烈的欢迎和广泛的使用。\x3c\/p\x3e\n\n\x3cp\x3e\x3c\/p\x3e"
  }
</script>


    <link href="http://kingjcy.github.io/css/styles.css" rel="stylesheet">
  </head>

  <body>
    
    
    

    <header class="l-header">
      <nav class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://kingjcy.github.io/">kingjcy Blog</a>
          </div>

          

        </div>
      </nav>
    </header>

    <main>
      <div class="container">
        
<div class="row">
  <div class="col-md-8">

    <nav class="p-crumb">
      <ol class="breadcrumb">
        <li><a href="http://kingjcy.github.io/"><i class="fa fa-home" aria-hidden="true"></i></a></li>
        
        <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="http://kingjcy.github.io/post/" itemprop="url"><span itemprop="title">post</span></a></li>
        
        <li class="active">redis tutorial</li>
      </ol>
    </nav>

    <article class="single">
  <header>
    <ul class="p-facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2016-05-28T09:56:46JST">May 28, 2016</time></li>
      <li><i class="fa fa-bookmark" aria-hidden="true"></i><a href="http://kingjcy.github.io/post/">post</a></li>
      
    </ul>

    <h1 class="title">redis tutorial</h1>
  </header>

  

  <div class="article-body"><p>redis是一款高性能的key-value型数据库，目前受到了强烈的欢迎和广泛的使用。</p>

<p></p>

<blockquote>
<h1 id="入门">入门</h1>
</blockquote>

<h2 id="基本数据类型操作使用">基本数据类型操作使用</h2>

<h4 id="strings">strings</h4>

<pre><code>set key value

get key &gt; value
</code></pre>

<h4 id="计数器">计数器</h4>

<pre><code>set connections 10

INCR connections &gt; 11

INCR connections &gt; 12

DEL  connections

INCR connections &gt; 1
</code></pre>

<p>INCR放在redis服务里面避免了多个客户端同时修改一个key导致最终的结果的错误。</p>

<h4 id="将一对键值对保留一段时间">将一对键值对保留一段时间</h4>

<pre><code>set key value

EXPIRE key 120

TTL key &gt; 113

(after 113s)

TTL key &gt; -2
</code></pre>

<p>-2就代表这个键值对不存在了，如果中途对key重新设置，则TTL会被reset为-1</p>

<h4 id="list列表操作">list列表操作</h4>

<pre><code>LPUSH，RPUSH 入表（入栈更加好理解一点）

LLEN         表的长度

LPOP,RPOP    出表（出栈）

LRANGE       显示列表一段内容
</code></pre>

<h4 id="set和sorted-sets">set和sorted sets</h4>

<pre><code>sadd key value 向集合里面新增内容

srem key value 重集合中删除

simember key value  判断是否在集合内

smembers key   展示集合的内容

sunion key1 key2    联合集合


zadd sets key value 向有序集合set中新增键值对

zrange key1 展示key1集合对一段内容
</code></pre>

<h4 id="hashes">hashes</h4>

<pre><code>hset struct key value  设置哈希结构的键值对

hgetall struct          获取哈希结构体的内容

hmset struct key1 value1 key2 value2...  

hget struct key     获取哈希结构体的单个键值对
</code></pre>

<h4 id="hash计数器">hash计数器</h4>

<pre><code>hset struct key 10

hincrby struct key 1 &gt; 11

hincrby struct key 10 &gt; 21

hdel struct key 

hincrby struct key 1 &gt; 1
</code></pre>

<h2 id="linux下redis的安装和使用">linux下redis的安装和使用</h2>

<ol>
<li><p>下载解压包 tar -zxf redis-3.0.7.tar.gz 到安装目录解压</p></li>

<li><p>make</p></li>

<li><p>make install</p></li>

<li><p>用 redis-server 配置文件 启动</p></li>

<li><p>用redis-cli客户端来连接-p表示端口，还有一些测试工具可以使用也可以用代码进行操作。</p></li>
</ol>

<blockquote>
<h1 id="specifications">Specifications</h1>
</blockquote>

<h2 id="redis-protocol">redis protocol</h2>

<p><strong>网络</strong></p>

<p>redis在tcp的6379端口来监听到来的连接，创建连接后来传输数据和命令，都是\r\n结尾的</p>

<p><strong>统一的请求协议</strong></p>

<p>*number of arguments CR LF</p>

<p>$number of bytes of argument 1 CR LF</p>

<p>argument data CR LF</p>

<p>&hellip;</p>

<p>$number of bytes of argument N CR LF</p>

<p><argument data> CR LF</p>

<p><strong>回复</strong></p>

<p>从第一个字节来校验回复的类型：</p>

<ul>
<li>用单行回复，回复的第一个字节将是“+”</li>
<li>错误消息，回复的第一个字节将是“-”</li>
<li>整型数字，回复的第一个字节将是“:”</li>
<li>批量回复，回复的第一个字节将是“$”  bulk strings 在$后面表示返回字符的长度，字符不存在则返回-1</li>
<li>多个批量回复，回复的第一个字节将是“*”  Arrays 在*后面表示返回的批量数，请求键不存在则返回0，请求超时或者键丢失返回-1。</li>
</ul>

<p>这些同样可以使用与请求协议中</p>

<h2 id="redis内部机制">redis内部机制</h2>

<p><strong>redis动态字符串</strong></p>

<pre><code>struct sdshdr {
    long len;
    long free;
    char buf[];
    };
</code></pre>

<p>这样一个结构体，代表这字符串的长度和内容。</p>

<pre><code>typedef char *sds;
</code></pre>

<p>一种char*类型的type：sds</p>

<p>利用如下的结构进行字符串存储</p>

<pre><code>struct sdshdr *sh;

-----------
|5|0|redis|
-----------
^   ^
sh  sh-&gt;buf

所以sh = zmalloc(sizeof(struct sdshdr)+initlen+1); 分配空间
    sh = (void*) (s-(sizeof(struct sdshdr))); 指针首位置，这边结构体是只会占用两个long的字节。
</code></pre>

<p><strong>Redis虚拟内存</strong></p>

<p>redis虚拟内存就是指swap出用disk磁盘上的空间来存储，key是必须存放在内存的，value经常使用的放在内存中，不经常使用的可以swap到disk上。具体应用还是要看场景是否适用，并不是用来就好。</p>

<p>配置后就可以使用了：</p>

<pre><code>vm-enabled yes
vm-pages 用于配置swap文件中页的总数
vm-page-size 用于配置页的字节数

# The default vm-max-threads configuration 线程式虚拟内存 阻塞式虚拟内存
vm-max-threads 4
</code></pre>

<p>至于实现原理这块还没有搞明白，鉴于这个功能目前实用性不大，之后研究。</p>

<p><strong>Redis事件库</strong></p>

<p>事件库就是用来监听端口，进行连接，接受数据，并进行各种操作的代码库。</p>

<p>redis事件库是基于epoll上实现的事件循环，在redis事件库中定义的读写事件和定时事件，先遍历当前时间最近的定时事件，计算出时间差作为对读写事件遍历的超时时间，避免了epoll超时影响定时事件的执行，遍历当前非定时事件，遇到需要处理的事件，就放入到已就绪的fired队列中，然后遍历这个队列进行fd事件的处理。直到定时事件的发生。依次循环完成了redis事件库的驱动。</p>

<p><strong>管道(pipelining)</strong></p>

<p>一次请求/响应服务器能实现处理新的请求即使旧的请求还未被响应。这样就可以将多个命令发送到服务器，而不用等待回复，最后在一个步骤中读取该答复。就是可以同时处理多个命令，最后一起读取结果。减少了每一次连接的时间。不管这个连接是RTT（连接慢）还是loopback（连接较快）。开启管道后效率可以提升五倍这样。</p>

<p><strong>pub/sub</strong></p>

<p>发布订阅是一种消息通信的模式，主要是为了解耦消息发布者和消息订阅者的耦合关系，类似于观察者模式。
redis的pub/sub是通过中间通道chaannel来实现的，其实就是key，然后通过subscribe／unsbuscribe/publish来对channel其实也就是key进行操作。</p>

<p><strong>过期</strong></p>

<ol>
<li>访问这个key时，发现其过期，进行删除操作</li>
<li>每隔10S，随机抽取20个key，删除过期的key，如果删除的大于25%，重复此操作</li>
<li>在复制aof文件期间，发现过期key就会将del操作一起合并到aof文件中</li>
</ol>

<p><strong>回收机制</strong></p>

<p>redis在内存达到设置的最大值时采取近似LUR(近期最少使用)算法回收，有对应的回收策略。所以正常是需要设置maxmemory的。</p>

<p><strong>redis主从复制</strong></p>

<p>redis的slave在第一次连接或者重新连接master的时候，会发送一个同步命令，然后master会收集出所有对数据修改的命令，然后向slave发送数据文件，给slave加载到内存中去，master接着发送所有收集的命令，完成主从的同步。</p>

<p><strong>持久化</strong></p>

<p>redis的持久化有两种，一种是rdb快照模式的数据备份，另外一种就是aof的命令备份模式。</p>

<ol>
<li><p>rdb
rdb就是通过fork出一个子进程来将现有的内存数据写入到一个rdb结尾的文件中，比如每五分钟进行一次数据备份，但是如果突然发送故障，会导致数据五分钟里面的数据丢失，所以需要aof的持久化方式。但是rdb在恢复数据的时候是比aof要快的。</p></li>

<li><p>aof
aof就是将redis执行的命令存储到一个结尾为aof的文件中，这个可以安排每秒进行一次备份操作，这样最多丢失一秒的数据。就具有很强的持久化能力了。而且aof会对文件进行重写，使得aof文件不易变的那么庞大。并且命令集便于分析查看。</p></li>
</ol>

<p><strong>信号与连接</strong></p>

<p>SIGTERM 设置一个定时任务SHUTDOWNredis实例。</p>

<p>SIGSEGV
SIGBUS
SIGFPE
SIGILL
直接终止。</p>

<p>redis连接也是基于socket，默认最大10000个客户端连接，可配置maxclients，可对客户端连接设置超时装置。</p>

<blockquote>
<h1 id="redis使用">redis使用</h1>
</blockquote>

<h3 id="内存优化">内存优化</h3>

<ul>
<li>使用特殊编码</li>
<li>使用32位实例内存要控制在4G内</li>
<li>使用bit级和byte级操作</li>
<li>尽可能的使用hashes</li>
<li>注意内存分配</li>
</ul>

<h3 id="redis事务">redis事务</h3>

<p>开启一个事务 MULTI 后面跟着操作，在执行EXEC前是不会被执行的，直到执行命令EXEC</p>

<p>在redis事务中有错误是不会回滚的，会返回错误继续执行下去，因为没有回滚的必要，必然是编码问题导致的。</p>

<p>放弃事务 DISCARD</p>

<p>乐观锁 WATCH 就是对key保持观察，在key发生变化期间不能完成当前对事务对操作。</p>

<h3 id="大量数据的插入">大量数据的插入</h3>

<p>使用redis客户端的pipe模式，原理同管道。</p>

<p>也可以重文件导入大量的数据，将命令写在txt文档里面，最好是文档进行转码，在server里面导入，结合上面的pipe模式比较实用。</p>

<h3 id="redis配置">redis配置</h3>

<ol>
<li><p>可以通过客户端&ndash;命令行配置</p></li>

<li><p>可以通过服务config命令行实现运行时配置修改。</p></li>

<li><p>配置有空格用双引号。</p></li>
</ol>

<h3 id="redis持久化">redis持久化</h3>

<p>数据备份</p>

<ul>
<li>创建一个定期任务（cron job）， 每小时将一个 RDB 文件备份到一个文件夹， 并且每天将一个 RDB 文件备份到另一个文件夹。</li>
<li>确保快照的备份都带有相应的日期和时间信息， 每次执行定期任务脚本时， 使用 find 命令来删除过期的快照： 比如说， 你可以保留最近 48 小时内的每小时快照， 还可以保留最近一两个月的每日快照。</li>
<li>至少每天一次， 将 RDB 备份到你的数据中心之外， 或者至少是备份到你运行 Redis 服务器的物理机器之外。</li>
</ul>

<p>容灾备份</p>

<p>Redis 的容灾备份基本上就是对数据进行备份， 并将这些备份传送到多个不同的外部数据中心。例如Amazon S3以及其他类型的S3，或者VPS来保存数据文件。</p>

<p>rdb文件：默认情况下，redis数据库快照是保存在dump.rdb文件中，可以手动设置，在配置文件中save/bgsave</p>

<pre><code>SAVE 60 1000   在60秒里有1000个键的改动。
</code></pre>

<p>aof文件：</p>

<pre><code>appendonly yes
</code></pre>

<p>redis会执行BGRWEWRITEAOF来进行数据的重写操作，如果aof文件损坏，可以使用redis-check-aof来修复。</p>

<p>正常建议同时使用rdb和aof持久化。</p>

<h3 id="redis-安全">redis 安全</h3>

<p>redis在安全方面并没有做太多的优化，只是支持密码的校验，通过AUTH来设置，还有只是对一些命令对禁用，使用配置文件中rename-command.</p></div>

  <footer class="article-footer">
    
    
    
    <section class="bordered">
      <header>
        <div class="panel-title">CATEGORIES</div>
      </header>
      <div>
        <ul class="p-terms">
          
          <li><a href="http://kingjcy.github.io/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a></li>
          
        </ul>
      </div>
    </section>
    
    
    
    <section class="bordered">
      <header>
        <div class="panel-title">TAGS</div>
      </header>
      <div>
        <ul class="p-terms">
          
          <li><a href="http://kingjcy.github.io/tags/redis/">redis</a></li>
          
          <li><a href="http://kingjcy.github.io/tags/nosql/">nosql</a></li>
          
        </ul>
      </div>
    </section>
    
    
  </footer>

</article>


    
  </div>

  <div class="col-md-4">
    
<aside class="l-sidebar">

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">LATESTS</div>
    </div>
    <div class="list-group">
      
      <a href="http://kingjcy.github.io/blog/2017/06/23/restful%E6%9E%B6%E6%9E%84/" class="list-group-item">restful架构</a>
      
      <a href="http://kingjcy.github.io/blog/2017/06/12/rbac%E6%A1%86%E6%9E%B6/" class="list-group-item">rbac框架</a>
      
      <a href="http://kingjcy.github.io/blog/2017/06/12/%E4%BB%8Eharbor%E5%85%A5%E6%89%8Bbeego%E6%A1%86%E6%9E%B6/" class="list-group-item">从harbor入手beego框架</a>
      
      <a href="http://kingjcy.github.io/blog/2017/06/07/chrome%E7%9A%84%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7/" class="list-group-item">chrome的开发者工具</a>
      
      <a href="http://kingjcy.github.io/blog/2017/06/06/gulp/" class="list-group-item">gulp</a>
      
      <a href="http://kingjcy.github.io/blog/2017/06/05/typescript/" class="list-group-item">typescript</a>
      
      <a href="http://kingjcy.github.io/blog/2017/06/01/web/" class="list-group-item">web</a>
      
      <a href="http://kingjcy.github.io/blog/2017/05/24/mac-os/" class="list-group-item">mac os</a>
      
      <a href="http://kingjcy.github.io/blog/2017/05/23/go%E7%A7%AF%E7%B4%AF/" class="list-group-item">go积累</a>
      
      <a href="http://kingjcy.github.io/blog/2017/04/21/kickstart/" class="list-group-item">kickstart</a>
      
    </div>
  </section>

  
  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">CATEGORY</div>
    </div>
    <div class="list-group">
      
      <a href="http://kingjcy.github.io/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0" class="list-group-item">技术文章</a>
      
      <a href="http://kingjcy.github.io/categories/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F" class="list-group-item">人生感悟</a>
      
    </div>
  </section>
  
  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">TAG</div>
    </div>
    <div class="list-group">
      
      <a href="http://kingjcy.github.io/tags/tool" class="list-group-item">tool</a>
      
      <a href="http://kingjcy.github.io/tags/linux" class="list-group-item">linux</a>
      
      <a href="http://kingjcy.github.io/tags/go" class="list-group-item">go</a>
      
      <a href="http://kingjcy.github.io/tags/language" class="list-group-item">language</a>
      
      <a href="http://kingjcy.github.io/tags/redis" class="list-group-item">redis</a>
      
      <a href="http://kingjcy.github.io/tags/thought" class="list-group-item">thought</a>
      
      <a href="http://kingjcy.github.io/tags/centos" class="list-group-item">centos</a>
      
      <a href="http://kingjcy.github.io/tags/ceph" class="list-group-item">ceph</a>
      
      <a href="http://kingjcy.github.io/tags/database" class="list-group-item">database</a>
      
      <a href="http://kingjcy.github.io/tags/fs" class="list-group-item">fs</a>
      
    </div>
  </section>
  

</aside>


  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="container">
        <p>Copyright (c) 2016. All rights reserved.</p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_beg">Beg</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

